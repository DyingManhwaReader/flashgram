<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flashgram</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg:          #0a0a0a;
      --surface:     #141414;
      --surface2:    #1c1c1c;
      --border:      #242424;
      --accent:      #e07a5f;
      --accent-dark: #c96a4f;
      --text:        #f0ece4;
      --muted:       #6b6b6b;
      --muted-light: #999;
    }
    * { box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; }

    /* â”€â”€ NAVBAR â”€â”€ */
    .navbar {
      background: rgba(10,10,10,.93) !important;
      backdrop-filter: blur(18px);
      border-bottom: 1px solid var(--border);
      height: 64px;
    }
    .navbar-brand {
      font-family: 'DM Serif Display', serif;
      font-style: italic; font-size: 1.75rem;
      background: linear-gradient(135deg, #e07a5f, #f2cc8f);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .btn-new-post {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border: none; color: #fff; border-radius: 50px;
      padding: 8px 20px; font-size: .85rem; font-weight: 600;
      transition: opacity .2s, transform .15s; cursor: pointer;
    }
    .btn-new-post:hover { opacity: .88; transform: scale(1.03); color: #fff; }

    /* â”€â”€ LIVE BADGE â”€â”€ */
    .badge-realtime {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: .68rem; color: #81b29a; font-weight: 500; margin-left: 8px;
      font-family: 'DM Sans', sans-serif;
    }
    .dot-live { width: 7px; height: 7px; border-radius: 50%; background: #81b29a; animation: pulse 1.6s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.25} }

    /* â”€â”€ STORIES â”€â”€ */
    .stories-bar { display: flex; gap: 16px; overflow-x: auto; padding: 16px 0 14px; scrollbar-width: none; }
    .stories-bar::-webkit-scrollbar { display: none; }
    .story-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; flex-shrink: 0; }
    .story-ring {
      width: 62px; height: 62px; border-radius: 50%;
      background: linear-gradient(135deg, #e07a5f, #f2cc8f, #81b29a);
      padding: 2.5px; display: flex; align-items: center; justify-content: center;
    }
    .story-ring .inner {
      width: 100%; height: 100%; border-radius: 50%;
      border: 2.5px solid var(--bg);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem; font-weight: 700; color: #fff;
      font-family: 'DM Serif Display', serif;
    }
    .story-label { font-size: 11px; color: var(--muted-light); max-width: 66px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* â”€â”€ POST CARD â”€â”€ */
    .post-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 18px; overflow: hidden; margin-bottom: 26px;
      transition: transform .2s, box-shadow .2s;
    }
    .post-card:hover { transform: translateY(-2px); box-shadow: 0 14px 44px rgba(0,0,0,.55); }

    .post-header { padding: 13px 16px; display: flex; align-items: center; gap: 11px; }
    .post-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: 'DM Serif Display', serif; font-size: 1.05rem;
      color: #fff; flex-shrink: 0; font-weight: 700;
    }
    .post-username { font-weight: 600; font-size: .9rem; line-height: 1.1; }
    .post-time { font-size: .73rem; color: var(--muted); }

    /* â”€â”€ MEDIA CAROUSEL â”€â”€ */
    .media-carousel { position: relative; background: #000; width: 100%; overflow: hidden; }
    .media-track {
      display: flex; transition: transform .35s cubic-bezier(.4,0,.2,1);
      will-change: transform;
    }
    .media-slide { flex: 0 0 100%; position: relative; }
    .media-slide img {
      width: 100%; max-height: 560px; object-fit: cover; display: block;
    }
    .media-slide video {
      width: 100%; max-height: 560px; object-fit: contain; display: block; background: #000;
    }

    .carousel-arrow {
      position: absolute; top: 50%; transform: translateY(-50%);
      background: rgba(0,0,0,.55); border: none; color: #fff;
      width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; z-index: 10; transition: background .2s;
    }
    .carousel-arrow:hover { background: rgba(0,0,0,.8); }
    .carousel-arrow.prev { left: 10px; }
    .carousel-arrow.next { right: 10px; }

    .carousel-dots {
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 5px; z-index: 10;
    }
    .carousel-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(255,255,255,.45); transition: background .2s, width .2s;
      cursor: pointer;
    }
    .carousel-dot.active { background: #fff; width: 18px; border-radius: 3px; }

    .slide-counter {
      position: absolute; top: 10px; right: 10px;
      background: rgba(0,0,0,.6); color: #fff; border-radius: 20px;
      padding: 2px 10px; font-size: .75rem; font-weight: 600; z-index: 10;
    }

    /* â”€â”€ POST ACTIONS â”€â”€ */
    .post-actions { padding: 12px 16px 0; display: flex; align-items: center; gap: 4px; }
    .action-btn {
      background: none; border: none; color: var(--muted-light);
      padding: 4px 10px 4px 0; display: flex; align-items: center; gap: 5px;
      font-size: .85rem; cursor: pointer; transition: color .15s;
    }
    .action-btn:hover { color: var(--text); }
    .action-btn i { font-size: 1.3rem; }
    .action-btn.liked { color: var(--accent); }
    .action-btn.liked i { animation: heartpop .3s ease; }
    @keyframes heartpop { 0%{transform:scale(1)} 45%{transform:scale(1.5)} 100%{transform:scale(1)} }

    .post-caption { padding: 8px 16px 4px; font-size: .88rem; color: #ccc; line-height: 1.55; }
    .post-caption strong { color: var(--text); margin-right: 5px; }

    .view-comments-btn {
      background: none; border: none; color: var(--muted);
      font-size: .8rem; padding: 2px 16px 6px; cursor: pointer; display: block;
    }
    .view-comments-btn:hover { color: var(--muted-light); }

    .comments-area { padding: 0 16px 6px; }
    .comment-item { font-size: .82rem; color: #bbb; margin-bottom: 6px; line-height: 1.4; }
    .comment-item strong { color: var(--text); margin-right: 5px; }

    /* â”€â”€ COMMENT FORM â”€â”€ */
    .comment-form {
      border-top: 1px solid var(--border);
      padding: 10px 16px; display: flex; flex-direction: column; gap: 8px;
    }
    .comment-name-row { display: flex; gap: 8px; align-items: center; }
    .comment-input-row { display: flex; gap: 8px; align-items: center; }
    .comment-name {
      flex: 1; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 20px; padding: 6px 14px; color: var(--text);
      font-family: 'DM Sans', sans-serif; font-size: .78rem; outline: none;
      transition: border-color .2s;
    }
    .comment-name::placeholder { color: var(--muted); }
    .comment-name:focus { border-color: var(--accent); }
    .comment-input {
      flex: 1; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 20px; padding: 8px 16px; color: var(--text);
      font-family: 'DM Sans', sans-serif; font-size: .82rem; outline: none;
      transition: border-color .2s;
    }
    .comment-input::placeholder { color: var(--muted); }
    .comment-input:focus { border-color: var(--accent); }
    .btn-comment-post {
      background: var(--accent); border: none; color: #fff;
      border-radius: 20px; padding: 7px 15px; font-size: .8rem;
      font-weight: 600; cursor: pointer; flex-shrink: 0; transition: background .2s;
    }
    .btn-comment-post:hover { background: var(--accent-dark); }

    /* â”€â”€ MODAL â”€â”€ */
    .modal-content { background: var(--surface); border: 1px solid var(--border); border-radius: 22px; color: var(--text); }
    .modal-header { border-bottom: 1px solid var(--border); padding: 18px 24px; }
    .modal-title  { font-family: 'DM Serif Display', serif; font-size: 1.35rem; }
    .btn-close    { filter: invert(1) brightness(.65); }
    .modal-body   { padding: 24px; }

    /* â”€â”€ UPLOAD ZONE â”€â”€ */
    .upload-zone {
      border: 2px dashed var(--border); border-radius: 14px;
      padding: 36px 20px; text-align: center; cursor: pointer;
      transition: border-color .2s, background .2s;
    }
    .upload-zone:hover { border-color: var(--accent); background: rgba(224,122,95,.05); }
    .upload-zone i { font-size: 2.4rem; display: block; margin-bottom: 10px; color: var(--muted); }
    .upload-zone p { color: var(--muted); font-size: .88rem; margin: 0 0 4px; }
    .upload-zone small { color: #444; font-size: .76rem; }

    .limit-pills { display: flex; gap: 8px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
    .limit-pill {
      display: inline-flex; align-items: center; gap: 5px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 20px; padding: 4px 12px; font-size: .75rem; color: var(--muted-light);
    }
    .limit-pill i { font-size: .85rem; }

    /* â”€â”€ MIN-FILES WARNING â”€â”€ */
    .min-files-warning {
      display: flex; align-items: center; gap: 8px;
      background: rgba(224,122,95,.08); border: 1px solid rgba(224,122,95,.25);
      border-radius: 10px; padding: 10px 14px; font-size: .82rem; color: #f2cc8f;
    }
    .min-files-warning i { font-size: 1.1rem; color: var(--accent); flex-shrink: 0; }

    /* â”€â”€ FILE PREVIEW GRID â”€â”€ */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
    }
    .preview-thumb {
      position: relative; border-radius: 10px; overflow: hidden;
      aspect-ratio: 1; background: #000;
    }
    .preview-thumb img, .preview-thumb video {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }
    .preview-thumb .remove-thumb {
      position: absolute; top: 4px; right: 4px;
      background: rgba(0,0,0,.7); border: none; color: #fff;
      border-radius: 50%; width: 22px; height: 22px;
      font-size: .8rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      line-height: 1;
    }
    .preview-thumb .type-badge {
      position: absolute; bottom: 4px; left: 4px;
      background: rgba(0,0,0,.65); color: #fff;
      border-radius: 4px; font-size: .65rem; padding: 2px 5px;
    }
    .preview-thumb .order-badge {
      position: absolute; top: 4px; left: 4px;
      background: var(--accent); color: #fff;
      border-radius: 50%; width: 20px; height: 20px;
      font-size: .7rem; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
    }

    .add-more-tile {
      border: 2px dashed var(--border); border-radius: 10px;
      aspect-ratio: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 4px;
      cursor: pointer; color: var(--muted); font-size: .72rem;
      transition: border-color .2s, color .2s;
    }
    .add-more-tile:hover { border-color: var(--accent); color: var(--accent); }
    .add-more-tile i { font-size: 1.4rem; }

    .file-count-bar {
      display: flex; align-items: center; justify-content: space-between;
      font-size: .78rem; color: var(--muted-light);
    }
    .file-count-bar .counts { display: flex; gap: 12px; }
    .file-count-bar .count-item { display: flex; align-items: center; gap: 4px; }

    .form-control-dark {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 11px; color: var(--text);
      font-family: 'DM Sans', sans-serif; padding: 12px 16px; font-size: .9rem;
    }
    .form-control-dark::placeholder { color: var(--muted); }
    .form-control-dark:focus { background: var(--surface2); border-color: var(--accent); color: var(--text); box-shadow: none; }

    .btn-share {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border: none; color: #fff; border-radius: 20px;
      padding: 13px; font-size: .95rem; font-weight: 600;
      width: 100%; cursor: pointer; transition: opacity .2s;
    }
    .btn-share:hover   { opacity: .88; }
    .btn-share:disabled { opacity: .35; cursor: not-allowed; }

    .upload-progress { height: 5px; border-radius: 4px; background: var(--border); overflow: hidden; }
    .upload-progress .bar { height: 100%; background: linear-gradient(90deg, var(--accent), #f2cc8f); transition: width .25s ease; }
    .upload-status { font-size: .78rem; color: var(--muted-light); text-align: center; }

    /* â”€â”€ FAB â”€â”€ */
    .fab {
      position: fixed; bottom: 28px; right: 28px; width: 58px; height: 58px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border: none; color: #fff; font-size: 1.5rem;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 8px 24px rgba(224,122,95,.42); cursor: pointer; z-index: 999;
      transition: transform .2s, box-shadow .2s;
    }
    .fab:hover { transform: scale(1.1); box-shadow: 0 12px 32px rgba(224,122,95,.6); }

    /* â”€â”€ SKELETON â”€â”€ */
    .skeleton {
      background: linear-gradient(90deg,var(--surface) 25%,var(--surface2) 50%,var(--surface) 75%);
      background-size: 200% 100%; animation: shimmer 1.4s infinite; border-radius: 8px;
    }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .skeleton-card { background: var(--surface); border: 1px solid var(--border); border-radius: 18px; overflow: hidden; margin-bottom: 26px; padding: 16px; }

    /* â”€â”€ NEW POST BANNER â”€â”€ */
    .new-post-banner {
      position: sticky; top: 72px; z-index: 90;
      background: rgba(129,178,154,.13); border: 1px solid rgba(129,178,154,.35);
      border-radius: 10px; padding: 10px 16px; margin-bottom: 16px;
      display: flex; align-items: center; gap: 10px; font-size: .85rem; cursor: pointer;
      backdrop-filter: blur(8px); animation: slideDown .3s ease;
    }
    @keyframes slideDown { from{transform:translateY(-10px);opacity:0} to{transform:translateY(0);opacity:1} }

    /* â”€â”€ TOAST â”€â”€ */
    .toast-container { position: fixed; top: 74px; right: 16px; z-index: 3000; }
    .toast { background: var(--surface2); border: 1px solid var(--border); color: var(--text); min-width: 240px; }

    /* â”€â”€ EMPTY â”€â”€ */
    .state-msg { text-align: center; padding: 80px 20px; color: var(--muted); }
    .state-msg i { font-size: 3rem; display: block; margin-bottom: 14px; }
    .state-msg p { font-size: .92rem; }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 4px; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• NAVBAR â•â•â•â•â•â•â•â•â•â• -->
<nav class="navbar sticky-top navbar-dark">
  <div class="container" style="max-width:700px;">
    <a class="navbar-brand mb-0 h1" href="#">
      flashgram
      <span class="badge-realtime" id="realtimeBadge" style="display:none;">
        <span class="dot-live"></span>live
      </span>
    </a>
    <button class="btn-new-post d-none d-sm-inline-flex align-items-center gap-2" onclick="openModal()">
      <i class="bi bi-plus-lg"></i> New Post
    </button>
  </div>
</nav>

<div class="toast-container" id="toastContainer"></div>

<!-- â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â• -->
<main class="container py-3 pb-5" style="max-width:700px;">
  <div class="stories-bar mb-1" id="storiesBar"></div>
  <hr style="border-color:var(--border);margin:0 0 22px;" />
  <div id="newPostBanner"></div>
  <div id="feed"></div>
</main>

<button class="fab d-sm-none" onclick="openModal()" title="New Post">
  <i class="bi bi-plus-lg"></i>
</button>

<!-- â•â•â•â•â•â•â•â•â•â• UPLOAD MODAL â•â•â•â•â•â•â•â•â•â• -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width:580px;">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title"><i class="bi bi-images me-2" style="color:var(--accent)"></i>New Post</span>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body d-flex flex-column gap-3">

        <!-- Drop zone -->
        <div id="uploadZone" class="upload-zone"
             onclick="document.getElementById('fileInput').click()"
             ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
             ondragleave="this.style.borderColor=''"
             ondrop="handleDrop(event)">
          <i class="bi bi-cloud-arrow-up"></i>
          <p>Click or drag &amp; drop to upload</p>
          <p style="color:var(--accent);font-weight:600;font-size:.82rem;margin:4px 0 0;">
            <i class="bi bi-info-circle"></i> Minimum 2 files required per post
          </p>
          <div class="limit-pills">
            <span class="limit-pill"><i class="bi bi-image"></i> Up to 20 photos</span>
            <span class="limit-pill"><i class="bi bi-camera-video"></i> Up to 10 videos</span>
          </div>
          <small class="d-block mt-2">JPG Â· PNG Â· GIF Â· WEBP Â· MP4 Â· MOV Â· WEBM</small>
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*" multiple class="d-none" onchange="handleFile(event)" />

        <!-- Min-files warning -->
        <div id="minFilesWarning" class="min-files-warning d-none">
          <i class="bi bi-exclamation-triangle"></i>
          <span>You need at least <strong>2 files</strong> to create a post. Please add more.</span>
        </div>

        <!-- File count bar -->
        <div id="fileCountBar" class="file-count-bar d-none">
          <div class="counts">
            <span class="count-item"><i class="bi bi-image" style="color:#81b29a"></i> <span id="imgCount">0</span>/20</span>
            <span class="count-item"><i class="bi bi-camera-video" style="color:#f2cc8f"></i> <span id="vidCount">0</span>/10</span>
          </div>
          <span style="color:var(--muted);font-size:.75rem;" id="totalCount"></span>
        </div>

        <!-- Preview grid -->
        <div id="previewGrid" class="preview-grid d-none"></div>

        <!-- Progress -->
        <div id="progressWrap" class="d-none">
          <div class="upload-progress mb-1"><div class="bar" id="progressBar" style="width:0%"></div></div>
          <div class="upload-status" id="uploadStatus">Preparingâ€¦</div>
        </div>

        <input type="text" id="inputUsername" class="form-control form-control-dark" placeholder="Your name (optional)" />
        <textarea id="inputCaption" class="form-control form-control-dark" rows="3" placeholder="Write a captionâ€¦" style="resize:none;"></textarea>
        <button class="btn-share" id="btnShare" disabled onclick="submitPost()">
          <i class="bi bi-send me-2"></i><span id="btnLabel">Share Post</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL  = "https://ficsnudofnyfprpfbqaq.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpY3NudWRvZm55ZnBycGZicWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzM3MjcsImV4cCI6MjA4NzAwOTcyN30.I9gfu175Mf6nW3BoBvvugZJVTscSL150n2fC7sjN4_Q";
const BUCKET        = "uploads";
const MAX_IMAGES    = 20;
const MAX_VIDEOS    = 10;
const MIN_FILES     = 2;
const AVATAR_COLORS = ["#e07a5f","#81b29a","#f2cc8f","#9b8ea8","#6b8cce","#e29578","#52796f","#d4a5a5"];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let posts           = [];
let uploadModal;
let pendingFiles    = [];
let isUploading     = false;
let pendingNewPosts = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener("DOMContentLoaded", async () => {
  uploadModal = new bootstrap.Modal(document.getElementById("uploadModal"));
  document.getElementById("uploadModal").addEventListener("hidden.bs.modal", resetModal);
  await fetchPosts();
  subscribeRealtime();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FETCH POSTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPosts() {
  showSkeletons();
  const { data, error } = await db
    .from("posts")
    .select(`*, post_media(id, media_url, media_type, sort_order), comments(id, username, text, created_at)`)
    .order("created_at", { ascending: false })
    .limit(50);

  if (error) {
    document.getElementById("feed").innerHTML = `
      <div class="state-msg"><i class="bi bi-wifi-off"></i>
      <p>Could not load posts.<br><small style="color:var(--muted)">Run the SQL setup then refresh.</small></p></div>`;
    showToast("DB: " + error.message, "danger");
    return;
  }
  posts = (data || []).map(normalise);
  renderStories();
  renderFeed();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REALTIME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function subscribeRealtime() {
  db.channel("realtime:posts")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "posts" }, async payload => {
      const { data } = await db
        .from("posts")
        .select(`*, post_media(id, media_url, media_type, sort_order), comments(id, username, text, created_at)`)
        .eq("id", payload.new.id)
        .single();
      if (data) {
        pendingNewPosts.unshift(normalise(data));
        showNewPostBanner();
      }
    })
    .on("postgres_changes", { event: "UPDATE", schema: "public", table: "posts" }, payload => {
      const local = posts.find(p => p.id === payload.new.id);
      if (local && !local.liked) {
        local.likes = payload.new.likes_count;
        const el = document.getElementById(`likeCount-${local.id}`);
        if (el) el.textContent = local.likes;
      }
    })
    .subscribe(status => {
      if (status === "SUBSCRIBED")
        document.getElementById("realtimeBadge").style.display = "inline-flex";
    });

  db.channel("realtime:comments")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "comments" }, payload => {
      const c    = payload.new;
      const post = posts.find(p => p.id === c.post_id);
      if (!post) return;
      const dup = post.comments.some(x => x.username === c.username && x.text === c.text);
      if (!dup) {
        post.comments.push({ username: c.username, text: c.text });
        appendCommentDOM(c.post_id, c.username, c.text);
        const cc = document.getElementById(`commentCount-${c.post_id}`);
        if (cc) cc.textContent = post.comments.length;
      }
    })
    .subscribe();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEW POST BANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showNewPostBanner() {
  document.getElementById("newPostBanner").innerHTML = `
    <div class="new-post-banner" onclick="flushNewPosts()">
      <i class="bi bi-arrow-up-circle-fill" style="color:#81b29a;font-size:1.2rem;"></i>
      <span>${pendingNewPosts.length} new post${pendingNewPosts.length>1?"s":""} â€” tap to load</span>
    </div>`;
}

function flushNewPosts() {
  posts = [...pendingNewPosts, ...posts];
  pendingNewPosts = [];
  document.getElementById("newPostBanner").innerHTML = "";
  renderStories(); renderFeed();
  window.scrollTo({ top:0, behavior:"smooth" });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NORMALISE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function normalise(row) {
  const media = (row.post_media || [])
    .sort((a,b) => a.sort_order - b.sort_order)
    .map(m => ({ url: m.media_url, type: m.media_type }));

  if (!media.length && row.media_url) {
    media.push({ url: row.media_url, type: row.media_type || "image" });
  }

  return {
    id:        row.id,
    username:  row.username      || "anonymous",
    avatar:    (row.avatar_letter || (row.username || "A")[0]).toUpperCase(),
    color:     row.avatar_color  || AVATAR_COLORS[0],
    caption:   row.caption       || "",
    media,
    likes:     row.likes_count   || 0,
    liked:     false,
    comments:  (row.comments || [])
                 .sort((a,b)=>new Date(a.created_at)-new Date(b.created_at))
                 .map(c=>({ username: c.username, text: c.text })),
    time:      timeAgo(row.created_at),
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStories() {
  const seen=new Set(); const unique=[];
  for (const p of posts) { if (!seen.has(p.username)) { seen.add(p.username); unique.push(p); } }
  document.getElementById("storiesBar").innerHTML = unique.slice(0,14).map(p=>`
    <div class="story-item" title="${esc(p.username)}">
      <div class="story-ring"><div class="inner" style="background:${p.color}">${p.avatar}</div></div>
      <span class="story-label">${esc(p.username)}</span>
    </div>`).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSkeletons() {
  document.getElementById("feed").innerHTML = [1,2,3].map(()=>`
    <div class="skeleton-card">
      <div class="d-flex align-items-center gap-3 mb-3">
        <div class="skeleton" style="width:44px;height:44px;border-radius:50%;flex-shrink:0;"></div>
        <div class="flex-grow-1">
          <div class="skeleton mb-2" style="height:12px;width:40%;"></div>
          <div class="skeleton" style="height:10px;width:22%;"></div>
        </div>
      </div>
      <div class="skeleton" style="height:320px;border-radius:10px;"></div>
    </div>`).join("");
}

function renderFeed() {
  const feed = document.getElementById("feed");
  if (!posts.length) {
    feed.innerHTML=`<div class="state-msg"><i class="bi bi-camera"></i><p>No posts yet. Be the first!</p></div>`;
    return;
  }
  feed.innerHTML = posts.map(buildPostHTML).join("");
}

function buildPostHTML(p) {
  const mediaCount = p.media.length;

  const slides = p.media.map((m, i) => `
    <div class="media-slide">
      ${m.type==="video"
        ? `<video src="${m.url}" controls playsinline preload="metadata"></video>`
        : `<img src="${m.url}" alt="slide ${i+1}" loading="lazy" />`}
    </div>`).join("");

  const dots = mediaCount > 1
    ? `<div class="carousel-dots">${p.media.map((_,i)=>`
        <div class="carousel-dot ${i===0?"active":""}" onclick="goSlide('${p.id}',${i})"></div>`).join("")}
       </div>` : "";

  const arrows = mediaCount > 1
    ? `<button class="carousel-arrow prev" onclick="prevSlide('${p.id}')"><i class="bi bi-chevron-left"></i></button>
       <button class="carousel-arrow next" onclick="nextSlide('${p.id}')"><i class="bi bi-chevron-right"></i></button>` : "";

  const counter = mediaCount > 1
    ? `<div class="slide-counter" id="counter-${p.id}">1 / ${mediaCount}</div>` : "";

  const commentsHTML = p.comments.map(c=>
    `<div class="comment-item"><strong>${esc(c.username)}</strong>${esc(c.text)}</div>`
  ).join("");

  return `
  <article class="post-card" id="post-${p.id}" data-slide="0" data-total="${mediaCount}">
    <div class="post-header">
      <div class="post-avatar" style="background:${p.color}">${p.avatar}</div>
      <div class="flex-grow-1">
        <div class="post-username">${esc(p.username)}</div>
        <div class="post-time">${p.time}</div>
      </div>
    </div>

    <div class="media-carousel">
      ${counter}${arrows}
      <div class="media-track" id="track-${p.id}">${slides}</div>
      ${dots}
    </div>

    <div class="post-actions">
      <button class="action-btn ${p.liked?"liked":""}" id="likeBtn-${p.id}" onclick="toggleLike('${p.id}')">
        <i class="bi ${p.liked?"bi-heart-fill":"bi-heart"}"></i>
        <span id="likeCount-${p.id}">${p.likes}</span>
      </button>
      <button class="action-btn" onclick="focusComment('${p.id}')">
        <i class="bi bi-chat"></i>
        <span id="commentCount-${p.id}">${p.comments.length}</span>
      </button>
      ${mediaCount>1?`<span style="margin-left:4px;font-size:.75rem;color:var(--muted)"><i class="bi bi-images"></i> ${mediaCount}</span>`:""}
      <button class="action-btn ms-auto"><i class="bi bi-bookmark"></i></button>
    </div>

    ${p.caption?`<div class="post-caption"><strong>${esc(p.username)}</strong>${esc(p.caption)}</div>`:""}

    ${p.comments.length>0?`
    <button class="view-comments-btn" id="vcbtn-${p.id}" onclick="toggleComments('${p.id}')">
      View all ${p.comments.length} comment${p.comments.length!==1?"s":""}
    </button>`:""}

    <div class="comments-area d-none" id="comments-${p.id}">${commentsHTML}</div>

    <div class="comment-form">
      <div class="comment-name-row">
        <i class="bi bi-person" style="color:var(--muted);font-size:1.1rem;"></i>
        <input class="comment-name" id="cname-${p.id}" placeholder="Your name (optional)" />
      </div>
      <div class="comment-input-row">
        <i class="bi bi-chat-dots" style="color:var(--muted);font-size:1.1rem;"></i>
        <input class="comment-input" id="cinput-${p.id}"
               placeholder="Write a commentâ€¦"
               onkeydown="if(event.key==='Enter')addComment('${p.id}')"
               oninput="togglePostBtn('${p.id}')" />
        <button class="btn-comment-post d-none" id="cbtn-${p.id}" onclick="addComment('${p.id}')">Post</button>
      </div>
    </div>
  </article>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CAROUSEL CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goSlide(postId, index) {
  const card = document.getElementById(`post-${postId}`);
  const total = parseInt(card.dataset.total);
  index = Math.max(0, Math.min(index, total-1));
  card.dataset.slide = index;

  document.getElementById(`track-${postId}`).style.transform = `translateX(-${index*100}%)`;

  card.querySelectorAll(".carousel-dot").forEach((d,i) => d.classList.toggle("active", i===index));

  const ctr = document.getElementById(`counter-${postId}`);
  if (ctr) ctr.textContent = `${index+1} / ${total}`;
}

function prevSlide(postId) {
  const card = document.getElementById(`post-${postId}`);
  goSlide(postId, parseInt(card.dataset.slide)-1);
}

function nextSlide(postId) {
  const card = document.getElementById(`post-${postId}`);
  goSlide(postId, parseInt(card.dataset.slide)+1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIKE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function toggleLike(id) {
  const p = posts.find(x=>x.id===id); if (!p) return;
  p.liked=!p.liked; p.likes+=p.liked?1:-1;
  const btn=document.getElementById(`likeBtn-${id}`);
  const icon=btn.querySelector("i");
  btn.classList.toggle("liked",p.liked);
  icon.className=p.liked?"bi bi-heart-fill":"bi bi-heart";
  document.getElementById(`likeCount-${id}`).textContent=p.likes;
  await db.from("posts").update({likes_count:p.likes}).eq("id",id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleComments(id) {
  const area=document.getElementById(`comments-${id}`);
  const btn=document.getElementById(`vcbtn-${id}`);
  const p=posts.find(x=>x.id===id);
  const hidden=area.classList.toggle("d-none");
  if (btn) btn.textContent=hidden
    ?`View all ${p.comments.length} comment${p.comments.length!==1?"s":""}`
    :"Hide comments";
}

function focusComment(id) {
  document.getElementById(`cinput-${id}`)?.focus();
  document.getElementById(`comments-${id}`)?.classList.remove("d-none");
}

function togglePostBtn(id) {
  const val=(document.getElementById(`cinput-${id}`)?.value||"").trim();
  document.getElementById(`cbtn-${id}`)?.classList.toggle("d-none",!val);
}

async function addComment(id) {
  const inp  = document.getElementById(`cinput-${id}`);
  const text = (inp?.value||"").trim();
  if (!text) return;

  const nameField = document.getElementById(`cname-${id}`);
  const username  = (nameField?.value||"").trim() || "anonymous";

  const p = posts.find(x=>x.id===id);
  if (p) p.comments.push({ username, text });
  appendCommentDOM(id, username, text);
  inp.value = "";
  document.getElementById(`cbtn-${id}`)?.classList.add("d-none");
  const cc = document.getElementById(`commentCount-${id}`);
  if (cc && p) cc.textContent = p.comments.length;

  const { error } = await db.from("comments").insert({ post_id:id, username, text });
  if (error) showToast("Comment failed: "+error.message, "danger");
}

function appendCommentDOM(postId, username, text) {
  const area = document.getElementById(`comments-${postId}`);
  if (!area) return;
  area.classList.remove("d-none");
  const div = document.createElement("div");
  div.className="comment-item";
  div.innerHTML=`<strong>${esc(username)}</strong>${esc(text)}`;
  area.appendChild(div);
  const vcbtn=document.getElementById(`vcbtn-${postId}`);
  if (vcbtn) vcbtn.textContent="Hide comments";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPLOAD MODAL â€” MULTI-FILE (MIN 2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal() { uploadModal.show(); }

function handleDrop(e) {
  e.preventDefault();
  document.getElementById("uploadZone").style.borderColor="";
  addFiles(Array.from(e.dataTransfer.files));
}

function handleFile(e) {
  addFiles(Array.from(e.target.files));
  e.target.value="";
}

function addFiles(newFiles) {
  let imgCount  = pendingFiles.filter(f=>f.type==="image").length;
  let vidCount  = pendingFiles.filter(f=>f.type==="video").length;
  const skipped = [];

  for (const file of newFiles) {
    const isVideo = file.type.startsWith("video/");
    const isImage = file.type.startsWith("image/");
    if (!isVideo && !isImage) continue;

    if (isVideo && vidCount >= MAX_VIDEOS) { skipped.push(file.name + " (video limit)"); continue; }
    if (isImage && imgCount >= MAX_IMAGES) { skipped.push(file.name + " (image limit)"); continue; }

    const reader = new FileReader();
    const entry  = { file, type: isVideo?"video":"image", previewUrl: null, id: Math.random().toString(36).slice(2) };
    pendingFiles.push(entry);
    isVideo ? vidCount++ : imgCount++;

    reader.onload = ev => {
      entry.previewUrl = ev.target.result;
      renderPreviewGrid();
    };
    reader.readAsDataURL(file);
  }

  if (skipped.length) showToast("Skipped: " + skipped.join(", "), "danger");
  updateShareButton();
  updateFileCountBar();
  if (pendingFiles.length) {
    document.getElementById("uploadZone").classList.add("d-none");
  }
}

function removeFile(entryId) {
  pendingFiles = pendingFiles.filter(f=>f.id!==entryId);
  updateShareButton();
  updateFileCountBar();
  renderPreviewGrid();
  if (!pendingFiles.length) {
    document.getElementById("uploadZone").classList.remove("d-none");
    document.getElementById("previewGrid").classList.add("d-none");
    document.getElementById("fileCountBar").classList.add("d-none");
    document.getElementById("minFilesWarning").classList.add("d-none");
  }
}

function updateShareButton() {
  const btn     = document.getElementById("btnShare");
  const warning = document.getElementById("minFilesWarning");
  const count   = pendingFiles.length;

  if (count >= MIN_FILES) {
    btn.disabled = false;
    warning.classList.add("d-none");
    document.getElementById("btnLabel").textContent = `Share Post (${count} file${count!==1?"s":""})`;
  } else if (count === 1) {
    btn.disabled = true;
    warning.classList.remove("d-none");
    document.getElementById("btnLabel").textContent = `Add ${MIN_FILES - count} more file to share`;
  } else {
    btn.disabled = true;
    warning.classList.add("d-none");
    document.getElementById("btnLabel").textContent = "Share Post";
  }
}

function renderPreviewGrid() {
  const grid = document.getElementById("previewGrid");
  grid.classList.remove("d-none");

  const imgCount = pendingFiles.filter(f=>f.type==="image").length;
  const vidCount = pendingFiles.filter(f=>f.type==="video").length;
  const canAddMore = imgCount < MAX_IMAGES || vidCount < MAX_VIDEOS;

  grid.innerHTML = pendingFiles.map((entry, i) => `
    <div class="preview-thumb">
      <span class="order-badge">${i+1}</span>
      ${entry.previewUrl
        ? (entry.type==="video"
            ? `<video src="${entry.previewUrl}" muted playsinline></video>`
            : `<img src="${entry.previewUrl}" alt="" />`)
        : `<div style="width:100%;height:100%;background:var(--surface2);display:flex;align-items:center;justify-content:center;">
             <div class="spinner-border spinner-border-sm text-secondary"></div>
           </div>`}
      <span class="type-badge">${entry.type==="video"?"â–¶ Video":"ğŸ–¼ Photo"}</span>
      <button class="remove-thumb" onclick="removeFile('${entry.id}')"><i class="bi bi-x"></i></button>
    </div>`).join("") +
    (canAddMore ? `
    <div class="add-more-tile" onclick="document.getElementById('fileInput').click()">
      <i class="bi bi-plus-circle"></i>
      <span>Add more</span>
    </div>` : "");
}

function updateFileCountBar() {
  const bar     = document.getElementById("fileCountBar");
  const imgEl   = document.getElementById("imgCount");
  const vidEl   = document.getElementById("vidCount");
  const totalEl = document.getElementById("totalCount");
  const imgs    = pendingFiles.filter(f=>f.type==="image").length;
  const vids    = pendingFiles.filter(f=>f.type==="video").length;

  if (pendingFiles.length) {
    bar.classList.remove("d-none");
    imgEl.textContent   = imgs;
    vidEl.textContent   = vids;
    const need = MIN_FILES - pendingFiles.length;
    totalEl.textContent = need > 0
      ? `${pendingFiles.length} file${pendingFiles.length!==1?"s":""} â€” need ${need} more`
      : `${pendingFiles.length} file${pendingFiles.length!==1?"s":""} selected âœ“`;
  } else {
    bar.classList.add("d-none");
  }
}

function clearAllMedia() {
  pendingFiles = [];
  document.getElementById("previewGrid").classList.add("d-none");
  document.getElementById("previewGrid").innerHTML = "";
  document.getElementById("fileCountBar").classList.add("d-none");
  document.getElementById("minFilesWarning").classList.add("d-none");
  document.getElementById("uploadZone").classList.remove("d-none");
  document.getElementById("btnShare").disabled = true;
}

function resetModal() {
  clearAllMedia();
  document.getElementById("inputUsername").value = "";
  document.getElementById("inputCaption").value  = "";
  document.getElementById("progressWrap").classList.add("d-none");
  document.getElementById("progressBar").style.width  = "0%";
  document.getElementById("uploadStatus").textContent = "Preparingâ€¦";
  document.getElementById("btnLabel").textContent     = "Share Post";
  document.getElementById("btnShare").disabled = true;
  isUploading = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBMIT POST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitPost() {
  if (pendingFiles.length < MIN_FILES) {
    showToast(`You need at least ${MIN_FILES} files to create a post.`, "danger");
    return;
  }
  if (isUploading) return;
  isUploading = true;

  const username = document.getElementById("inputUsername").value.trim() || "anonymous";
  const caption  = document.getElementById("inputCaption").value.trim();
  const color    = AVATAR_COLORS[Math.floor(Math.random()*AVATAR_COLORS.length)];
  const avatar   = username[0].toUpperCase();

  document.getElementById("progressWrap").classList.remove("d-none");
  document.getElementById("btnShare").disabled = true;
  document.getElementById("btnLabel").textContent = "Uploadingâ€¦";

  const total = pendingFiles.length;
  const uploadedUrls = [];

  for (let i=0; i<total; i++) {
    const entry = pendingFiles[i];
    setProgress(`Uploading file ${i+1} of ${total}â€¦`, Math.round(((i)/total)*75));

    const ext      = (entry.file.name.split(".").pop()||"bin").toLowerCase();
    const filePath = `${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;

    const { error: storageErr } = await db.storage
      .from(BUCKET)
      .upload(filePath, entry.file, { cacheControl:"3600", upsert:false });

    if (storageErr) {
      showToast(`File ${i+1} upload failed: ${storageErr.message}`, "danger");
      resetModal(); return;
    }

    const { data: urlData } = db.storage.from(BUCKET).getPublicUrl(filePath);
    uploadedUrls.push({ url: urlData.publicUrl, type: entry.type });
  }

  setProgress("Saving postâ€¦", 85);

  const { data: postRow, error: postErr } = await db
    .from("posts")
    .insert({ username, avatar_letter:avatar, avatar_color:color, caption, likes_count:0 })
    .select()
    .single();

  if (postErr) { showToast("DB error: "+postErr.message, "danger"); resetModal(); return; }

  setProgress("Saving mediaâ€¦", 92);

  const mediaRows = uploadedUrls.map((m, idx) => ({
    post_id:    postRow.id,
    media_url:  m.url,
    media_type: m.type,
    sort_order: idx,
  }));

  const { error: mediaErr } = await db.from("post_media").insert(mediaRows);
  if (mediaErr) { showToast("Media link error: "+mediaErr.message, "danger"); resetModal(); return; }

  setProgress("Done! ğŸ‰", 100);
  showToast(`ğŸ‰ Post shared with ${total} files!`, "success");
  setTimeout(()=>uploadModal.hide(), 700);
}

function setProgress(msg, pct) {
  document.getElementById("uploadStatus").textContent = msg;
  document.getElementById("progressBar").style.width  = pct + "%";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(message, type="info") {
  const colors={success:"#81b29a",danger:"#e07a5f",info:"#6b8cce"};
  const id="t"+Date.now();
  const el=document.createElement("div");
  el.id=id; el.className="toast align-items-center show mb-2";
  el.style.borderLeft=`3px solid ${colors[type]||"#555"}`;
  el.innerHTML=`<div class="d-flex">
    <div class="toast-body" style="font-size:.85rem;">${esc(message)}</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto"
            onclick="document.getElementById('${id}').remove()"></button>
  </div>`;
  document.getElementById("toastContainer").appendChild(el);
  setTimeout(()=>el?.remove(), 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(str) {
  return String(str||"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function timeAgo(ts) {
  if (!ts) return "";
  const s=Math.floor((Date.now()-new Date(ts))/1000);
  if (s<60)    return "just now";
  if (s<3600)  return Math.floor(s/60)+"m ago";
  if (s<86400) return Math.floor(s/3600)+"h ago";
  return Math.floor(s/86400)+"d ago";
}
</script>
</body>
</html>
